<!DOCTYPE html>
<html lang="en">
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base target="_top">
  <link rel="shortcut icon" href="https://www.gstatic.com/images/branding/product/1x/sheets_2020q4_48dp.png" type="image/x-icon">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SWAL2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.css" />
  <title>Careleavers Details</title>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#" onclick="event.preventDefault();">Careleavers Details</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" id="a-entry" href="#" onclick="event.preventDefault(); showTab('entry')">Data Entry</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="a-view" href="#" onclick="event.preventDefault(); showTab('view')">View Data</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container mt-4">
    <!-- Data Entry Tab -->
    <div id="entry" class="tab-content">
      <h2 class="my-4">Data Entry Form</h2>
      <form id="dataForm" onsubmit="event.preventDefault(); saveFormData();">
        <div class="mb-3">
          <label for="district" class="form-label">District</label>
          <select class="form-select" id="district" name="district" onchange="loadCCIs()" required>
            <option value="">Select District</option>
            {% for district in districts %}
              <option value="{{ district }}">{{ district }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="cci" class="form-label">CCI Name</label>
          <select class="form-select" id="cci" name="cci" required>
            <option value="">Select CCI</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="child-name" class="form-label">Name of the Child</label>
          <input type="text" class="form-control" id="child-name" name="child-name" required>
        </div>
        <div class="mb-3">
          <label for="dob" class="form-label">Date of Birth</label>
          <input type="date" class="form-control" id="dob-dt" name="dob" required>
        </div>
        <div class="mb-3">
          <label for="gender" class="form-label">Gender</label>
          <select class="form-select" id="gender" name="gender" required>
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="category" class="form-label">Category</label>
          <select class="form-select" id="category" name="category" required>
            <option value="">Select Category</option>
            <option value="CNCP-non CWSN">CNCP-non CWSN</option>
            <option value="CNCP-CWSN">CNCP-CWSN</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="release-dt" class="form-label">Date of Release from CCI</label>
          <input type="date" class="form-control" id="release-dt" name="release-dt" required>
        </div>
        <div class="mb-3">
          <label for="authority-name" id="authority-label" class="form-label">Name of the CWC</label>
          <select class="form-select" id="authority-name" name="authority-name" required>
            <option value="">Select CWC</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="control-label">Was SIR Order Done?</label>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="is-sir-order-done-yes" name="is-sir-order-done" value="Yes">
            <label class="form-check-label" for="is-sir-order-done-yes">Yes</label>
          </div>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="is-sir-order-done-no" name="is-sir-order-done" value="No" checked>
            <label class="form-check-label" for="is-sir-order-done-no">No</label>
          </div>
        </div>
        <div id="sirOrderDetails" style="display: none;">
        <div class="mb-3">
          <label class="control-label">SIR Status</label>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="sir-status-pending" name="sir-status" value="Pending" checked>
            <label class="form-check-label" for="sir-status-pending">Pending</label>
          </div>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="sir-status-submitted" name="sir-status" value="Submitted">
            <label class="form-check-label" for="sir-status-submitted">Submitted</label>
          </div>
        </div>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>

    <!-- View Data Tab -->
    <div id="view" class="tab-content">
      <h2 class="my-4">View Data</h2>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="filterDistrict" class="form-label">District</label>
          <select class="form-select" id="filterDistrict" onchange="loadFilterCCI();loadFilteredData();">
            <option value="">All Districts</option>
            {% for district in districts %}
            <option value="{{ district }}">{{ district }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label for="filterCCI" class="form-label">CCI Name</label>
          <select class="form-select" id="filterCCI" onchange="loadFilteredData()">
            <option value="">Select CCI</option>
          </select>
        </div>
      </div>
      <table class="display stripe" id="dataTable" style="width:80%;">
        <thead>
          <tr>
            <th>#</th>
            <th>District</th>
            <th>CCI Name</th>
            <th>Name of the Child</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Category</th>
            <th>Date of Admission</th>
            <th>Placement Order By</th>
            <th>Order No</th>
            <th>Order Date</th>
            <th>SIR Order No</th>
            <th>SIR Order Date</th>
            <th>SIR Due Date</th>
            <th>SIR Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data rows will be populated here -->
        </tbody>
      </table>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
  <script>
    // Show/hide tabs
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      document.getElementById(tabName).style.display = 'block';
      if (tabName === 'view') {
        document.getElementById('a-entry').classList.remove('active');
        document.getElementById('a-view').classList.add('active');
        document.getElementById('filterDistrict').selectedIndex = 0;
        loadFilteredData();
      }
      else {
        document.getElementById('a-view').classList.remove('active');
        document.getElementById('a-entry').classList.add('active');
        loadAuthorities();
        setMaxDateInput();
      }
    }

    // Show/hide SIR Order details
    document.getElementById('is-sir-order-done-yes').addEventListener('change', function() {
      document.getElementById('sirOrderDetails').style.display = 'block';
      document.getElementById('sir-order-no').setAttribute('required', 'required');
      document.getElementById('sir-order-dt').setAttribute('required', 'required');
      document.getElementById('sir-due-dt').setAttribute('required', 'required');
    });
    document.getElementById('is-sir-order-done-no').addEventListener('change', function() {
      document.getElementById('sirOrderDetails').style.display = 'none';
      document.getElementById('sir-order-no').removeAttribute('required');
      document.getElementById('sir-order-dt').removeAttribute('required');
      document.getElementById('sir-due-dt').removeAttribute('required');
    });

    // Load Authority Names
    function loadAuthorities() {
      const authoritySelect = document.getElementById('authority-name');
      const authorityLabel = document.getElementById('authority-label');
      const placedBy = document.querySelector('input[name="placed-by"]:checked').value;

      authoritySelect.innerHTML = '<option value="">Select ' + placedBy + '</option>';
      authorityLabel.textContent = 'Name of the ' + placedBy;

      let authorities = [
        'Alipurduar',
        'Bankura',
        'Birbhum',
        'Cooch Behar',
        'Dakshin Dinajpur',
        'Darjeeling',
        'Hooghly',
        'Howrah',
        'Jalpaiguri',
        'Jhargram',
        'Kalimpong',
        'Kolkata',
        'Malda',
        'Murshidabad',
        'Nadia',
        'North 24 Parganas',
        'Paschim Medinipur',
        'Pascim Bardhaman',
        'Purba Medinipur',
        'Purba Bardhaman',
        'Purulia',
        'South 24 Parganas',
        'Uttar Dinajpur'
      ];

      if (placedBy === 'CWC') {
        authorities.push("Siliguri");
        authorities.push("Sunderban");
        authorities.sort();
      }
        
      authorities.forEach(authority => {
        const option = document.createElement('option');
        option.value = authority;
        option.textContent = authority;
        authoritySelect.appendChild(option);
      });
    }

    // Function to set date input max to today
    function setMaxDateInput() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('admission-dt').setAttribute('max', today);
      document.getElementById('placement-order-dt').setAttribute('max', today);
      document.getElementById('sir-order-dt').setAttribute('max', today);
    }

    // Load Districts
    fetch('/get_districts')
     .then(response => response.json())

    // Add event listeners to "placed-by" radio buttons
    document.querySelectorAll('input[name="placed-by"]').forEach(radio => {
      radio.addEventListener('change', loadAuthorities);
    });

    function loadCCIs() {
      const district = document.getElementById('district').value;
      if (!district) return;
      fetch('/get_ccis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ district: district })
      })
      .then(response => response.json())
      .then(data => {
        const cciSelect = document.getElementById('cci');
        cciSelect.innerHTML = '<option value="">Select CCI</option>';
        data.forEach(cci => {
          const option = document.createElement('option');
          option.value = cci[0];
          option.textContent = cci[1];
          cciSelect.appendChild(option);
        });
      });
    }

    function loadFilterCCI() {
      const district = document.getElementById('filterDistrict').value;
      if (!district) {
        document.getElementById('filterCCI').innerHTML = '<option value="">Select CCI</option>';
        return;
      }
      fetch('/get_ccis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ district: district })
      })
      .then(response => response.json())
      .then(data => {
        const cciSelect = document.getElementById('filterCCI');
        cciSelect.innerHTML = '<option value="">Select CCI</option>';
        data.forEach(cci => {
          const option = document.createElement('option');
          option.value = cci[0];
          option.textContent = cci[1];
          cciSelect.appendChild(option);
        });
      });
    }

    // Save form data
    function saveFormData() {
      const formData = new FormData(document.getElementById('dataForm'));
      const data = Object.fromEntries(formData.entries());

      fetch('/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.status) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: result.message,
          });
          document.getElementById('dataForm').reset();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: result.message,
          });
        }
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'An error occurred while saving the data.',
        });
      });
    }

    // Load filtered data for viewing
    function loadFilteredData() {
      // Destroy existing DataTable instance
      if ($.fn.DataTable.isDataTable('#dataTable')) {
        $('#dataTable').DataTable().destroy();
      }
      const district = document.getElementById('filterDistrict').value;
      const cci = document.getElementById('filterCCI').value;
      fetch('/view', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          district: district || '',
          cci: cci || ''
        })
      })
      .then(response => response.json())
      .then(data => {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = ''; // Clear existing rows

        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.sl_no}</td>
            <td>${row.district}</td>
            <td>${row.cci}</td>
            <td>${row.child_name}</td>
            <td>${row.age}</td>
            <td>${row.gender}</td>
            <td>${row.category}</td>
            <td>${row.admission_dt}</td>
            <td>${row.order_by}</td>
            <td>${row.order_no}</td>
            <td>${row.order_dt}</td>
            <td>${row.sir_order_no}</td>
            <td>${row.sir_order_dt}</td>
            <td>${row.sir_due_dt}</td>
            <td>${row.sir_status}</td>
          `;
          tbody.appendChild(tr);
        });

        // Initialize DataTable
        $('#dataTable').DataTable({
          responsive: true,
          scrollX: true
        });
      })
      .catch(error => {
        console.error('Error loading data:', error);
      });
    }

    // Initialize the page
    window.onload = () => {
      showTab('entry');
    };
  </script>
</body>
</html>